- name: Force clear apt locks and corrupted cache
  ansible.builtin.shell: |
    rm -f /var/lib/apt/lists/lock
    rm -f /var/cache/apt/archives/lock
    rm -f /var/lib/dpkg/lock*
    apt-get clean
    rm -rf /var/lib/apt/lists/*
  become: true
  changed_when: true

- name: Remove legacy Docker repository entry
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
    state: absent
  become: true

- name: Remove legacy Docker GPG key file
  ansible.builtin.file:
    path: /usr/share/keyrings/docker-archive-keyring.gpg
    state: absent
  become: true

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Install prerequisite packages
  ansible.builtin.apt:
    name: [apt-transport-https, ca-certificates, curl, software-properties-common, python3-pip, gnupg]
    state: present
    update_cache: true
  become: true

- name: Download Docker GPG key
  ansible.builtin.shell: |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
    gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg
  become: true

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
    state: present
  become: true

- name: Install Docker SDK for Python
  ansible.builtin.pip:
    name: docker
  become: true

- name: Install Docker CE
  ansible.builtin.apt:
    name: [docker-ce, docker-ce-cli, containerd.io]
    state: present
    update_cache: true
  become: true

- name: Ensure Docker volume exists
  community.docker.docker_volume:
    name: "{{ db_volume }}"
    state: present

- name: Log in to Docker Hub
  community.docker.docker_login:
    username: "{{ dockerhub_user }}"
    password: "{{ lookup('env', 'DOCKERHUB_TOKEN') }}"
  when: lookup('env', 'DOCKERHUB_TOKEN') != ""

- name: Pull and Run MiniTwit Container
  community.docker.docker_container:
    name: "{{ container_name }}"
    image: "{{ dockerhub_user }}/{{ image_name }}:{{ app_version }}"
    state: started
    restart_policy: always
    recreate: true
    ports:
      - "{{ host_port }}:{{ app_port }}"
    volumes:
      - "{{ db_volume }}:/app/data"
    env:
      CHIRPDBPATH: "/app/data/minitwit.db"

- name: Cleanup dangling images
  community.docker.docker_prune:
    images: true
    images_filters:
      dangling: true
