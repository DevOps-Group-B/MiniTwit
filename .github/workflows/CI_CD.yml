# --- PIPELINE SUMMARY ---
# 1. Trigger: Runs automatically on a push to the 'main' branch or manually via workflow_dispatch.
# 2. Build & Test: Checks out code, sets up .NET, restores, and builds the project.
#    Installs Playwright dependencies and runs all Unit, Integration, and E2E tests. 
#    If any test fails, the pipeline halts immediately to protect the production server.
# 3. Docker Image: If tests pass, it logs into Docker Hub, builds a new image using the GitHub run 
#    number as a tag (e.g., :45), and pushes it to the registry.
# 4. Deployment: Connects to the DigitalOcean droplet via SSH, pulls the new image, and swaps containers.
#    It mounts a Managed Docker Volume and passes the DB path as an environment variable so the 
#    simulator's registered users and cheeps survive the deployment.

name: CI_CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read 

env:
  IMAGE_NAME: minitwitimage
  CONTAINER_NAME: minitwit
  APP_PORT: "5273"
  HOST_PORT: "80"

jobs:
  build_test_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # --- STAGE 1: SETUP ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # --- STAGE 2: BUILD & TEST ---
      - name: Restore dependencies
        working-directory: itu-minitwit
        run: dotnet restore

      - name: Build project
        working-directory: itu-minitwit
        run: dotnet build --no-restore

      # Playwright requires actual browser binaries to run E2E tests in the headless Ubuntu runner
      - name: Install Playwright Browsers
        working-directory: itu-minitwit
        run: |
          dotnet tool install --global Microsoft.Playwright.CLI
          playwright install --with-deps chromium

      # Run all tests. If this fails, the action STOPS here and will not deploy bad code.
      - name: Test
        working-directory: itu-minitwit
        run: dotnet test --no-build --verbosity normal

      # --- STAGE 3: DOCKER HUB PUBLISHING ---
      # Everything below this line ONLY runs if all tests passed successfully!

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Builds the image and tags it with both the unique GitHub run number and :latest
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./itu-minitwit
          file: ./itu-minitwit/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      # --- STAGE 4: SERVER DEPLOYMENT ---
      - name: Deploy via SSH (docker run)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            
            # 1. Authenticate and pull the newly built image
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}"

            # 2. Stop and remove the old container
            docker rm -f "${{ env.CONTAINER_NAME }}" || true

            # 3. Ensure the Managed Docker Volume exists to keep the SQLite database safe
            docker volume create minitwit_db_volume || true

            # 4. Run the new container with the volume (-v) and environment variable (-e)
            docker run -d --restart always \
              -p "${{ env.HOST_PORT }}:${{ env.APP_PORT }}" \
              --name "${{ env.CONTAINER_NAME }}" \
              -v minitwit_db_volume:/app/data \
              -e CHIRPDBPATH=/app/data/minitwit.db \
              "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}"

            # 5. Clean up old, unused images to save disk space on the DigitalOcean droplet
            docker image prune -f || true
