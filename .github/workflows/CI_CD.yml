#Small summary of what happens here:
# First, it's on push to main this action will run, it also has write permissions and the following environment name with the eventual image
# name, container name and app and host port when it deploys. Then it will pull the latest code and install dependencies and generates a 
# unique version tag using the format prod-[run_number]-[short_sha] e.g prod-14-a1b2c3d.
# Then the workflow authenticates with Docker Hub using the stored Github Action secrets, it builds the docker image from the itu-minitwit 
# directory with two tags: The unique version tag (for rollbacks) and the latest.
# Then it connects to our digitalocean server using SSH, it pulls the docker images, stops and removes any existing containers and launches
# the new one. Finally it creates a github release using git tags, as well as release notes. 


name: CI_CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write   # needed for creating tags/releases

env:
  IMAGE_NAME: minitwitimage
  CONTAINER_NAME: minitwit
  APP_PORT: "5273"
  HOST_PORT: "80"

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        working-directory: itu-minitwit/src/MiniTwit.Web
        run: dotnet restore
      # This is for later when we implement testing
      #- name: Test
      #  working-directory: itu-minitwit
      #  run: dotnet test --configuration Release --verbosity normal

      - name: Set version tag
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="prod-${{ github.run_number }}-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./itu-minitwit
          file: ./itu-minitwit/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy via SSH (docker run)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          password: ${{ secret.SSH_PASSPHRASE }}
          script: |
            set -euo pipefail
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}"

            docker rm -f "${{ env.CONTAINER_NAME }}" || true

            docker run -d --restart always \
              -p "${{ env.HOST_PORT }}:${{ env.APP_PORT }}" \
              --name "${{ env.CONTAINER_NAME }}" \
              "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}"

            docker image prune -f || true

      - name: Create GitHub Release (what is deployed)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
