# Summary of this workflow:
# First, it's on push to main this action will run, it also has write permissions and the following environment name with the eventual image
# name, container name and app and host port when it deploys. Then it will pull the latest code and install dependencies. 
# Then the workflow authenticates with Docker Hub using the stored Github Action secrets, it builds the docker image from the itu-minitwit 
# directory with two tags: The unique version tag (for rollbacks) and the latest.
# Then it connects to our digitalocean server using SSH, it pulls the docker images, stops and removes any existing containers and launches
# the new one.


name: CI_CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

env:
  IMAGE_NAME: minitwitimage
  CONTAINER_NAME: minitwit
  APP_PORT: "5273"
  HOST_PORT: "80"

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        working-directory: itu-minitwit/src/MiniTwit.Web
        run: dotnet restore

      - name: Set version tag
        id: version
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="prod-${{ github.run_number }}-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./itu-minitwit
          file: ./itu-minitwit/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy via SSH (docker run)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail
            
            # Login and Pull
            docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"
            docker pull "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}"

            # Stop and remove the old container
            docker rm -f "${{ env.CONTAINER_NAME }}" || true

            # 1. Ensure the Managed Docker Volume exists
            docker volume create minitwit_db_volume || true

            # 2. Run the new container, mounting the Managed Volume (-v) and setting the Env Var (-e)
            docker run -d --restart always \
              -p "${{ env.HOST_PORT }}:${{ env.APP_PORT }}" \
              --name "${{ env.CONTAINER_NAME }}" \
              -v minitwit_db_volume:/app/data \
              -e CHIRPDBPATH=/app/data/minitwit.db \
              "${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.tag }}"

            # Cleanup old images
            docker image prune -f || true