# Summary of this workflow:
# This action runs every Friday at 11:59 or can be triggered manually.
# It checks out the repository, generates a new incrementing release tag (prod-N), and collects commit messages from the past week.
# Then it creates a GitHub release with the new tag and release notes summarizing the weekâ€™s changes.


name: Weekly Release
on:
  schedule:
    - cron: '59 11 * * 5'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  create_weekly_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Tag
        id: tag
        run: |
          LATEST_TAG=$(git tag --list 'prod-*' | sed 's/prod-//' | sort -n | tail -1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_VERSION=1
          else
            NEXT_VERSION=$((LATEST_TAG + 1))
          fi
          TAG_NAME="prod-${NEXT_VERSION}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Create and push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}

      - name: Generate Release Notes
        id: notes
        run: |
          echo "## Weekly Changes (${{ steps.tag.outputs.tag }})" > release_notes.md
          echo "" >> release_notes.md
          git log --oneline --since="7 days ago" >> release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "No changes in the last 7 days." > release_notes.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
